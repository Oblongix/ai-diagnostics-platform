<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oblongix Service Guide</title>
    <style>
        :root {
            --bg: #f3f7fd;
            --card: #ffffff;
            --text: #15233f;
            --muted: #5d6f92;
            --border: #d8e2f2;
            --brand: #174f80;
            --brand2: #2f7ec5;
            --accent: #eaf3ff;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Plus Jakarta Sans", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background:
                radial-gradient(circle at 0% 0%, rgba(77, 145, 203, 0.12), transparent 40%),
                radial-gradient(circle at 100% 0%, rgba(23, 79, 128, 0.12), transparent 35%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .wrap {
            max-width: 1160px;
            margin: 0 auto;
            display: grid;
            gap: 12px;
        }
        .panel {
            border: 1px solid var(--border);
            border-radius: 14px;
            background: var(--card);
            box-shadow: 0 10px 28px rgba(16, 36, 77, 0.08);
            padding: 16px;
        }
        .hero h1 {
            margin: 0;
            font-size: 1.6rem;
            line-height: 1.2;
        }
        .hero p {
            margin: 8px 0 0;
            color: var(--muted);
        }
        .chips {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .chip {
            border: 1px solid var(--border);
            border-radius: 999px;
            background: #f8fbff;
            color: #2d517a;
            padding: 2px 9px;
            font-size: 0.78rem;
            font-weight: 700;
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .project-selector {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: end;
        }
        .project-selector label {
            display: block;
            margin: 0 0 6px;
            color: var(--muted);
            font-size: 0.82rem;
            font-weight: 700;
        }
        .project-selector select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            color: var(--text);
            padding: 10px;
            font: inherit;
        }
        .project-selector-status {
            margin-top: 8px;
            color: var(--muted);
            font-size: 0.82rem;
        }
        .btn {
            display: inline-block;
            text-decoration: none;
            border-radius: 8px;
            padding: 9px 13px;
            font-weight: 700;
            border: 1px solid var(--border);
            color: var(--text);
            background: #fff;
        }
        .btn-primary {
            color: #fff;
            border-color: transparent;
            background: linear-gradient(135deg, var(--brand), var(--brand2));
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        h2 {
            margin: 0 0 8px;
            font-size: 1.02rem;
        }
        ul {
            margin: 0;
            padding-left: 18px;
            display: grid;
            gap: 5px;
            color: #2c4b74;
        }
        .steps {
            display: grid;
            gap: 10px;
        }
        .step {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            padding: 11px;
        }
        .step h3 {
            margin: 0 0 6px;
            font-size: 0.98rem;
        }
        .small {
            margin: 0 0 8px;
            color: var(--muted);
            font-size: 0.86rem;
        }
        .step-deliverables {
            border: 1px solid #d9e6f8;
            border-radius: 8px;
            background: #f8fbff;
            padding: 8px;
        }
        .step-deliverables strong {
            display: block;
            margin-bottom: 5px;
            color: #29537d;
            font-size: 0.84rem;
        }
        .step-outputs {
            margin-top: 8px;
            border: 1px solid #dfe7f4;
            border-radius: 8px;
            background: #fff;
            padding: 8px;
        }
        .step-outputs strong {
            display: block;
            margin-bottom: 5px;
            color: #435c7f;
            font-size: 0.84rem;
        }
        .outcome {
            border: 1px solid #cce2ff;
            background: linear-gradient(135deg, #f8fbff, #eef6ff);
            border-radius: 12px;
            padding: 12px;
            color: #2d527d;
        }
        .outcome h2 {
            margin-bottom: 5px;
        }
        .project-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 8px;
        }
        .project-meta {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #f8fbff;
            padding: 8px;
        }
        .project-meta strong {
            display: block;
            margin-bottom: 3px;
            color: #2b517c;
            font-size: 0.84rem;
            font-weight: 700;
        }
        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .project-grid {
                grid-template-columns: 1fr;
            }
            .project-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <main class="wrap">
        <section class="panel">
            <h2>Select Project</h2>
            <div class="project-selector">
                <div>
                    <label for="projectSelect">Project</label>
                    <select id="projectSelect"></select>
                </div>
                <button id="projectSelectBtn" class="btn btn-primary" type="button">Select Project</button>
            </div>
            <p id="projectSelectorStatus" class="project-selector-status"></p>
        </section>
        <section class="panel">
            <h2>Project Details</h2>
            <div id="projectDetails" class="project-grid"></div>
        </section>
        <section id="hero" class="panel hero"></section>
        <section class="grid">
            <article class="panel">
                <h2>Key Inputs</h2>
                <ul id="keyInputs"></ul>
            </article>
            <article class="panel">
                <h2>Stakeholders</h2>
                <ul id="stakeholders"></ul>
            </article>
        </section>
        <section class="panel">
            <h2>Execution Steps and Deliverables</h2>
            <div id="steps" class="steps"></div>
        </section>
        <section class="panel outcome">
            <h2>Example Final Outcome</h2>
            <p id="outcomeText"></p>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    <script src="diagnostic-data.js"></script>
    <script src="service-guides.js"></script>
    <script>
        (function () {
            var CATALOG_STORAGE_KEY = 'aiDiagnosticsPlatform.serviceCatalog.v1';
            function esc(value) {
                return String(value == null ? '' : value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
            function loadCatalogFromStorage() {
                try {
                    var raw = window.localStorage.getItem(CATALOG_STORAGE_KEY);
                    if (!raw) return null;
                    var parsed = JSON.parse(raw);
                    if (!parsed || typeof parsed !== 'object') return null;
                    if (!Object.keys(parsed).length) return null;
                    return parsed;
                } catch (e) {
                    return null;
                }
            }
            function normalizeText(value, fallback) {
                var text = String(value == null ? '' : value).trim();
                if (text) return text;
                return String(fallback == null ? '' : fallback).trim();
            }
            function uniqueList(items) {
                var seen = {};
                var out = [];
                (Array.isArray(items) ? items : []).forEach(function (item) {
                    var text = String(item == null ? '' : item).trim();
                    if (!text) return;
                    if (seen[text]) return;
                    seen[text] = true;
                    out.push(text);
                });
                return out;
            }
            function normalizeServiceId(value) {
                return String(value == null ? '' : value)
                    .trim()
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
            function buildDeliverableCatalog(serviceDeliverables) {
                var byId = {};
                var byTitle = {};
                var ordered = [];
                (Array.isArray(serviceDeliverables) ? serviceDeliverables : []).forEach(function (item, index) {
                    var title = normalizeText(item && item.title, '');
                    if (!title) return;
                    var id =
                        normalizeServiceId((item && item.id) || title) ||
                        'deliverable-' + String(index + 1);
                    if (byId[id]) return;
                    byId[id] = title;
                    byTitle[String(title).toLowerCase()] = id;
                    ordered.push(id);
                });
                return {
                    byId: byId,
                    byTitle: byTitle,
                    ordered: ordered,
                };
            }
            function resolveDeliverableId(token, catalog) {
                var raw = String(token == null ? '' : token).trim();
                if (!raw) return '';
                var asId = normalizeServiceId(raw);
                if (asId && catalog.byId[asId]) return asId;
                var asTitle = catalog.byTitle[String(raw).toLowerCase()];
                return asTitle || '';
            }
            function normalizeStepObjects(rawSteps, serviceDeliverables) {
                var catalog = buildDeliverableCatalog(serviceDeliverables || []);
                var base = Array.isArray(rawSteps) && rawSteps.length ? rawSteps : [];
                var mapped = base.map(function (item, index) {
                    if (item && typeof item === 'object') {
                        var explicitDeliverableIds = uniqueList(item.deliverableIds || [])
                            .map(function (id) {
                                return resolveDeliverableId(id, catalog);
                            })
                            .filter(Boolean);
                        var legacyDeliverables = uniqueList(item.deliverables || []);
                        var resolvedLegacyIds = [];
                        var unresolvedLegacyOutputs = [];
                        legacyDeliverables.forEach(function (token) {
                            var resolved = resolveDeliverableId(token, catalog);
                            if (resolved) resolvedLegacyIds.push(resolved);
                            else unresolvedLegacyOutputs.push(token);
                        });
                        var outputs = uniqueList((item.outputs || []).concat(unresolvedLegacyOutputs));
                        return {
                            name: String(item.name || 'Step ' + String(index + 1)),
                            focus: String(item.focus || 'Focus area for consultants during this phase.'),
                            deliverableIds: uniqueList(explicitDeliverableIds.concat(resolvedLegacyIds)),
                            outputs: outputs,
                        };
                    }
                    return {
                        name: String(item || 'Step ' + String(index + 1)),
                        focus: 'Focus area for consultants during this phase.',
                        deliverableIds: [],
                        outputs: [],
                    };
                });
                if (!mapped.length) {
                    mapped = [
                        { name: 'Align and Scope', focus: 'Set scope and objectives.', deliverableIds: [], outputs: [] },
                        { name: 'Diagnose Current State', focus: 'Assess current baseline and risks.', deliverableIds: [], outputs: [] },
                        { name: 'Design and Decide', focus: 'Design target approach and key decisions.', deliverableIds: [], outputs: [] },
                        { name: 'Embed and Transfer', focus: 'Finalize outputs and handover.', deliverableIds: [], outputs: [] },
                    ];
                }
                var hasAssignments = mapped.some(function (step) {
                    return Array.isArray(step.deliverableIds) && step.deliverableIds.length;
                });
                if (!hasAssignments && catalog.ordered.length) {
                    catalog.ordered.forEach(function (id, index) {
                        var stepIndex = index % mapped.length;
                        mapped[stepIndex].deliverableIds.push(id);
                    });
                }
                mapped.forEach(function (step) {
                    var ids = uniqueList(step.deliverableIds || [])
                        .map(function (id) {
                            return resolveDeliverableId(id, catalog);
                        })
                        .filter(Boolean);
                    step.deliverableIds = ids;
                    step.deliverables = ids.map(function (id) {
                        return catalog.byId[id] || id;
                    });
                    step.outputs = uniqueList(step.outputs || []);
                    if (!step.outputs.length && !step.deliverables.length) {
                        step.outputs = ['Step decision note', 'Step completion summary'];
                    }
                });
                return mapped;
            }

            var params = new URLSearchParams(window.location.search || '');
            var serviceIdParam = params.get('serviceId') || '';
            var pageParam = params.get('page') || '';
            var deliverableId = params.get('deliverableId') || '';
            var projectId = params.get('projectId') || '';
            var projectName = params.get('projectName') || '';
            var catalog = loadCatalogFromStorage() || window.serviceCatalog || {};
            var guides = window.serviceGuides || {};
            var keys = Object.keys(catalog);
            var projectLookup = {};

            var selectedId = serviceIdParam;
            if (!selectedId && pageParam && catalog[pageParam]) selectedId = pageParam;
            if (!selectedId && keys.length) selectedId = keys[0];

            var service = catalog[selectedId] || null;
            var guide =
                (service && service.guide && typeof service.guide === 'object' && service.guide) ||
                ((selectedId && guides[selectedId]) || null);

            if (!service) {
                document.getElementById('hero').innerHTML =
                    '<h1>No service selected</h1><p>Select a valid serviceId in the URL query.</p>';
                return;
            }

            function setProjectSelectorStatus(message) {
                var status = document.getElementById('projectSelectorStatus');
                if (status) status.textContent = String(message || '');
            }
            function renderProjectDetails() {
                document.getElementById('projectDetails').innerHTML =
                    '<article class="project-meta"><strong>Project Name</strong><span>' +
                    esc(projectName || 'Not provided') +
                    '</span></article>' +
                    '<article class="project-meta"><strong>Project ID</strong><span>' +
                    esc(projectId || 'Not provided') +
                    '</span></article>' +
                    '<article class="project-meta"><strong>Service ID</strong><span>' +
                    esc(selectedId || 'Not provided') +
                    '</span></article>' +
                    '<article class="project-meta"><strong>Deliverable ID</strong><span>' +
                    esc(deliverableId || 'Not provided') +
                    '</span></article>';
            }
            function renderProjectSelector(projects) {
                var select = document.getElementById('projectSelect');
                if (!select) return;
                var list = Array.isArray(projects) ? projects : [];
                projectLookup = {};
                select.innerHTML = '';
                list.forEach(function (project) {
                    projectLookup[project.id] = project;
                    var option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name || project.id;
                    select.appendChild(option);
                });
                if (projectId && !projectLookup[projectId]) {
                    var selectedOption = document.createElement('option');
                    selectedOption.value = projectId;
                    selectedOption.textContent = projectName || projectId;
                    select.appendChild(selectedOption);
                }
                var createOption = document.createElement('option');
                createOption.value = '__create__';
                createOption.textContent = 'Create New Project...';
                select.appendChild(createOption);

                if (projectId && (projectLookup[projectId] || projectName)) {
                    select.value = projectId;
                } else if (list.length) {
                    select.value = list[0].id;
                    projectId = list[0].id;
                    projectName = list[0].name || list[0].id;
                } else {
                    select.value = '__create__';
                }
                renderProjectDetails();
            }
            async function loadProjectsForSelector() {
                var services = window.firebaseServices || {};
                var auth = services.auth;
                var db = services.db;
                if (!auth || !db || !auth.onAuthStateChanged) {
                    renderProjectSelector([]);
                    setProjectSelectorStatus('Sign in to load your projects list.');
                    return;
                }
                auth.onAuthStateChanged(async function (user) {
                    if (!user) {
                        renderProjectSelector([]);
                        setProjectSelectorStatus('Sign in to load your projects list.');
                        return;
                    }
                    try {
                        var snap;
                        try {
                            snap = await db
                                .collection('projects')
                                .where('teamMembers', 'array-contains', user.uid)
                                .orderBy('updatedAt', 'desc')
                                .get();
                        } catch (orderedError) {
                            snap = await db
                                .collection('projects')
                                .where('teamMembers', 'array-contains', user.uid)
                                .get();
                        }
                        var projects = (snap.docs || []).map(function (doc) {
                            var data = doc.data ? doc.data() : {};
                            return {
                                id: doc.id,
                                name: String(data.clientName || data.name || doc.id),
                            };
                        });
                        renderProjectSelector(projects);
                        setProjectSelectorStatus(
                            projects.length
                                ? 'Select a project and open it, or choose Create New Project.'
                                : 'No projects found. Choose Create New Project.'
                        );
                    } catch (error) {
                        console.error('Could not load projects for selector', error);
                        renderProjectSelector([]);
                        setProjectSelectorStatus('Could not load projects. You can still create a new project.');
                    }
                });
            }

            var stepObjects = normalizeStepObjects(guide && guide.steps, service.deliverables || []);
            renderProjectDetails();
            var hero = document.getElementById('hero');
            hero.innerHTML =
                '<h1>' +
                esc(service.name || selectedId) +
                '</h1><p>' +
                esc(
                    (guide && guide.fullDescription) ||
                        service.description ||
                        'Consultant guide page for this service.'
                ) +
                '</p><div class="chips"><span class="chip">Service ID: ' +
                esc(selectedId) +
                '</span><span class="chip">Category: ' +
                esc(service.category || 'Uncategorized') +
                '</span><span class="chip">Page: ' +
                esc(pageParam || selectedId) +
                '</span>' +
                (deliverableId ? '<span class="chip">Deliverable: ' + esc(deliverableId) + '</span>' : '') +
                '</div><div class="actions"><a class="btn btn-primary" href="index.html?view=dashboard">Return to Dashboard</a></div>';

            if (document.getElementById('projectSelectBtn')) {
                document.getElementById('projectSelectBtn').addEventListener('click', function () {
                    var select = document.getElementById('projectSelect');
                    var selectedProjectId = String((select && select.value) || '').trim();
                    if (!selectedProjectId) return;
                    if (selectedProjectId === '__create__') {
                        window.location.assign('index.html?action=new-project');
                        return;
                    }
                    var selectedProject = projectLookup[selectedProjectId] || {
                        id: selectedProjectId,
                        name:
                            (select && select.options && select.selectedIndex >= 0
                                ? select.options[select.selectedIndex].textContent
                                : selectedProjectId) || selectedProjectId,
                    };
                    projectId = selectedProject.id;
                    projectName = selectedProject.name || selectedProject.id;
                    renderProjectDetails();
                    var target = new URL('index.html', window.location.href);
                    target.searchParams.set('view', 'diagnostic');
                    target.searchParams.set('projectId', projectId);
                    target.searchParams.set('projectName', projectName);
                    window.location.assign(target.toString());
                });
            }
            loadProjectsForSelector();

            var keyInputs =
                (guide && Array.isArray(guide.keyInputs) && guide.keyInputs.length
                    ? guide.keyInputs
                    : ['Strategic priorities', 'Current-state baseline', 'Risk and control constraints']) || [];
            document.getElementById('keyInputs').innerHTML = keyInputs
                .map(function (item) {
                    return '<li>' + esc(item) + '</li>';
                })
                .join('');

            var stakeholders =
                (guide && Array.isArray(guide.stakeholders) && guide.stakeholders.length
                    ? guide.stakeholders
                    : ['Executive sponsor', 'Delivery owner', 'Domain stakeholders']) || [];
            document.getElementById('stakeholders').innerHTML = stakeholders
                .map(function (item) {
                    return '<li>' + esc(item) + '</li>';
                })
                .join('');

            document.getElementById('steps').innerHTML = stepObjects
                .map(function (step, index) {
                    var deliverablesHtml = Array.isArray(step.deliverables) && step.deliverables.length
                        ? '<ul>' +
                          step.deliverables
                              .map(function (title, titleIndex) {
                                  var text = String(title || '');
                                  var mappedId =
                                      Array.isArray(step.deliverableIds) && step.deliverableIds[titleIndex]
                                          ? String(step.deliverableIds[titleIndex])
                                          : '';
                                  var highlight =
                                      deliverableId &&
                                      (text.toLowerCase().indexOf(String(deliverableId).toLowerCase()) >= 0 ||
                                          mappedId.toLowerCase() === String(deliverableId).toLowerCase())
                                          ? ' style="font-weight:800;"'
                                          : '';
                                  return '<li' + highlight + '>' + esc(text) + '</li>';
                              })
                              .join('') +
                          '</ul>'
                        : '<ul><li>No catalog deliverables attached to this step.</li></ul>';
                    var outputsHtml = Array.isArray(step.outputs) && step.outputs.length
                        ? '<ul>' +
                          step.outputs
                              .map(function (output) {
                                  return '<li>' + esc(output) + '</li>';
                              })
                              .join('') +
                          '</ul>'
                        : '<ul><li>No additional outputs listed for this step.</li></ul>';
                    return (
                        '<article class="step"><h3>' +
                        esc('Step ' + String(index + 1) + ': ' + step.name) +
                        '</h3><p class="small">' +
                        esc(step.focus || 'Focus area for consultants during this phase.') +
                        '</p><div class="step-deliverables"><strong>Deliverables for this step</strong>' +
                        deliverablesHtml +
                        '</div><div class="step-outputs"><strong>Other Step Outputs</strong>' +
                        outputsHtml +
                        '</div></article>'
                    );
                })
                .join('');

            document.getElementById('outcomeText').textContent =
                (guide && guide.outcomeExample) ||
                'Client has clear ownership, delivery outputs, and executive-ready evidence of progress for this service.';
        })();
    </script>
</body>
</html>
